{% extends 'base.html.twig' %}

{% block javascript %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2"></script>
<script src="{{ asset('assets/plugins/moment/moment.js') }}"></script>
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.js'></script>
<script src="https://www.jsdelivr.com/package/npm/@fullcalendar/bootstrap5?version=6.1.19"></script>
<script src="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.19/locales-all.global.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(el => new bootstrap.Tooltip(el));
});
document.addEventListener("DOMContentLoaded", function () {

    // Données des tests
    const data = {
        dates: [
            {% for t in aquarium.tests %}
                "{{ t.date|date('Y-m-d') }}",
            {% endfor %}
        ],
        ph: [
            {% for t in aquarium.tests %}
                {{ t.ph }},
            {% endfor %}
        ],
        gh: [
            {% for t in aquarium.tests %}
                {{ t.gh }},
            {% endfor %}
        ],
        kh: [
            {% for t in aquarium.tests %}
                {{ t.kh }},
            {% endfor %}
        ],
        no2: [
            {% for t in aquarium.tests %}
                {{ t.no2 }},
            {% endfor %}
        ],
        no3: [
            {% for t in aquarium.tests %}
                {{ t.no3 }},
            {% endfor %}
        ],
        nhx: [
            {% for t in aquarium.tests %}
                {{ t.nhx }},
            {% endfor %}
        ],
        conductivite: [
            {% for t in aquarium.tests %}
                {{ t.conductivite }},
            {% endfor %}
        ],
    };
    var calendar;

    // Limites envoyées par le contrôleur (phMin, phMax, etc.)
    // Exemple côté contrôleur : 'limits' => ['ph' => ['min' => $aquarium->getPhMin(), 'max' => $aquarium->getPhMax()], ...]
    const limits = {{ limits|json_encode|raw }};
    if(document.getElementById('rapportChart')) {
        const ctx = document.getElementById('rapportChart').getContext('2d');

        let chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.dates,
                datasets: [{
                    label: "pH",
                    data: data.ph,
                    borderWidth: 2,
                    tension: 0.25,
                    borderColor: '#4bc0c0',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    pointRadius: 3,
                    pointBackgroundColor: '#fff',
                    pointBorderColor: '#4bc0c0'
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: false,
                        ticks: { color: "#fff" }
                    },
                    x: {
                        ticks: { color: "#fff" }
                    }
                },
                plugins: {
                    legend: {
                        labels: { color: "#fff" }
                    },
                    annotation: {
                        annotations: {} // rempli dynamiquement selon le paramètre choisi
                    }
                }
            }
        });

        // Fonction utilitaire pour mettre à jour les zones selon le paramètre (key)
        function updateAnnotationsFor(key) {
            // Réinitialise les annotations
            chart.options.plugins.annotation.annotations = {};

            // Si on a des limites configurées pour ce paramètre
            if (limits[key] && limits[key].min !== null && limits[key].max !== null) {
                chart.options.plugins.annotation.annotations.zoneVerte = {
                    type: 'box',
                    yMin: limits[key].min,
                    yMax: limits[key].max,
                    backgroundColor: 'rgba(0, 255, 0, 0.12)',
                    borderColor: 'rgba(0, 255, 0, 0.5)',
                    borderWidth: 1
                };
            }
        }

        // Initialisation des annotations pour le pH au chargement
        updateAnnotationsFor('ph');
        chart.update();

        // Événement sur le sélecteur de paramètre
        document.getElementById('rapport-select').addEventListener('change', function () {
            const key = this.value; // ph, gh, kh, no2, no3, nhx, conductivite...

            // Mise à jour du dataset
            chart.data.datasets[0].label = key.toUpperCase();
            chart.data.datasets[0].data = data[key];

            // Mise à jour des zones en fonction des limites du paramètre choisi
            updateAnnotationsFor(key);

            chart.update();
        });
    }
    function functionhandleRenderFullcalendar () {
        // fullcalendar
        var d = new Date();
        var month = d.getMonth() + 1;
            month = (month < 10) ? '0' + month : month;
        var year = d.getFullYear();
        var day = d.getDate();
        var today = moment().startOf('day');
        var calendarElm = document.getElementById('calendar');
        calendar = new FullCalendar.Calendar(calendarElm, {
            locale: 'fr',
            headerToolbar: {
                left: 'dayGridMonth,timeGridWeek,timeGridDay',
                center: 'title',
                right: 'prev,next today'
            },
            initialView: 'dayGridMonth',
            editable: false,
            droppable: false,
            themeSystem: 'bootstrap',
            views: {
                listDay: { buttonText: 'list day' },
                listWeek: { buttonText: 'list week' },
                listMonth: { buttonText: 'list month' },
            },
            events: {
                url: '{{ path('app_aquarium_evenements', {id: aquarium.id}) }}',
                failure: function() {
                    console.error('Erreur lors du chargement des événements');
                }
            },
            eventContent: function(arg) {
                const desc = arg.event.extendedProps.description || '';
                return {
                    html: '<div>' + arg.event.title + '<br><small>' + desc + '</small></div>'
                };
            },
            datesSet: function(info) {
                // Recharge les événements quand on change de vue ou de plage de dates
                calendar.refetchEvents();
            }
        });

        calendar.render();
    };
    const planningTab = document.querySelector('a[href="#tab-planning"][data-bs-toggle="tab"]');
    planningTab.addEventListener('shown.bs.tab', function (event) {
        functionhandleRenderFullcalendar();
    });
});

</script>
{% endblock %}

{% block stylesheet %}
<style>
    .btn-outline-light:hover {
        background: rgba(0,123,255,0.3) !important;
        border-color: rgba(0,123,255,0.6) !important;
        color: #fff !important;
    }

    #rapportChart {
        max-height: 420px;
    }
</style>
{% endblock %}

{% block page %}

<div class="page-header mb-4 d-flex align-items-center justify-content-between">

    <div class="d-flex align-items-center gap-3">
        <h1 class="page-header-title text-white mb-0">
            {{ aquarium.name }}
        </h1>

        <a href="{{ path('app_aquarium_edit', {id: aquarium.id}) }}"
           data-bs-toggle="tooltip"
           title="Modifier l'aquarium"
           class="btn btn-sm btn-outline-light d-flex align-items-center shadow-sm"
           style="border-color: rgba(255,255,255,0.25); background: rgba(255,255,255,0.05); padding: 4px 8px;">
            <i class="bi bi-pencil-square fs-5"></i>
        </a>
    </div>

    <div class="text-white-50 small text-end">
        Volume : {{ aquarium.volume }} L •
        Température : {{ aquarium.temperature ?? '—' }}°C •
        Mise en eau : {{ aquarium.wateringDate ? aquarium.wateringDate|date('d/m/Y') : '—' }}
    </div>
</div>



<!-- BEGIN card -->
<div class="card">
    <div class="card-body">

        <!-- NAVIGATION DES ONGLETS -->
        <ul class="nav nav-tabs mb-4" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" data-bs-toggle="tab" href="#tab-general">Général</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#tab-poissons">Poissons</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#tab-invertebres">Invertébrés</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#tab-plantes">Plantes</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#tab-analyses">Analyses</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#tab-planning">Planning</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#tab-rapport">Rapport</a>
            </li>
        </ul>

        <!-- CONTENU DES ONGLETS -->
        <div class="tab-content">

            {{ include('aquarium/index.pane.general.html.twig', { aquarium: aquarium }) }}

            {{ include('aquarium/index.pane.poisson.html.twig', { aquarium: aquarium }) }}

            {{ include('aquarium/index.pane.invertebre.html.twig', { aquarium: aquarium }) }}

            {{ include('aquarium/index.pane.plante.html.twig', { aquarium: aquarium }) }}

            {{ include('aquarium/index.pane.analyse.html.twig', { aquarium: aquarium }) }}

            {{ include('aquarium/index.pane.planning.html.twig', { aquarium: aquarium }) }}

            {{ include('aquarium/index.pane.rapport.html.twig', { aquarium: aquarium }) }}

        </div>

    </div>

    <!-- CARD ARROW -->
    <div class="card-arrow">
        <div class="card-arrow-top-left"></div>
        <div class="card-arrow-top-right"></div>
        <div class="card-arrow-bottom-left"></div>
        <div class="card-arrow-bottom-right"></div>
    </div>
</div>
<!-- END card -->

{% endblock %}
